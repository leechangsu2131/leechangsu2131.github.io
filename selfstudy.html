<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교사 셀프스터디 지원 플랫폼 - 나만의 수업 연구실</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .data-management {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-btn:hover, .nav-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .record-interface {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .record-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }

        .record-history {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            max-height: 600px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .tag-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .tag {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: inline-block;
            margin: 2px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 0.8rem;
        }

        .record-item {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .record-type {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .record-date {
            color: #7f8c8d;
            font-size: 0.8rem;
        }

        .record-content {
            margin: 10px 0;
            line-height: 1.5;
        }

        .record-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .search-filter {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
        }

        .filter-select {
            min-width: 150px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .timeline {
            position: relative;
            margin: 30px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 100%;
            background: #667eea;
        }

        .timeline-item {
            position: relative;
            margin: 20px 0;
            padding: 0 20px;
        }

        .timeline-item:nth-child(odd) {
            text-align: right;
            padding-right: 50%;
        }

        .timeline-item:nth-child(even) {
            text-align: left;
            padding-left: 50%;
        }

        .timeline-dot {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
        }

        .insight-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border-left: 5px solid #667eea;
        }

        .connection-map {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            animation: slideIn 0.5s ease;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .record-interface {
                grid-template-columns: 1fr;
            }
            
            .search-filter {
                flex-direction: column;
            }
            
            .search-input, .filter-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>나만의 수업 연구실</h1>
            <p>체계적인 셀프스터디를 통한 교사 전문성 개발 플랫폼</p>
        </div>

        <!-- 데이터 관리 도구바 -->
        <div class="data-management">
            <button class="btn btn-small" onclick="exportData()">📥 데이터 다운로드</button>
            <input type="file" id="importFile" accept=".json" onchange="importData()" style="display: none;">
            <button class="btn btn-small btn-secondary" onclick="document.getElementById('importFile').click()">📤 데이터 불러오기</button>
            <button class="btn btn-small btn-secondary" onclick="clearAllData()">🗑️ 데이터 초기화</button>
            <div style="flex: 1;"></div>
            <span id="dataStatus">데이터 상태: 준비됨</span>
        </div>

        <div class="navigation">
            <button class="nav-btn active" onclick="showSection('record')">기록하기</button>
            <button class="nav-btn" onclick="showSection('analyze')">분석하기</button>
            <button class="nav-btn" onclick="showSection('insight')">통찰 도출</button>
            <button class="nav-btn" onclick="showSection('portfolio')">성장 포트폴리오</button>
        </div>

        <!-- 기록하기 섹션 -->
        <div class="content-section active" id="record">
            <h2 class="section-title">수업 기록 및 성찰</h2>
            
            <div class="record-interface">
                <div class="record-form">
                    <h3>새로운 기록 작성</h3>
                    
                    <div class="form-group">
                        <label>기록 유형</label>
                        <select id="recordType">
                            <option value="reflection">수업 성찰</option>
                            <option value="observation">수업 관찰</option>
                            <option value="student_work">학생 결과물 분석</option>
                            <option value="experiment">수업 실험</option>
                            <option value="question">탐구 질문</option>
                            <option value="insight">깨달음/통찰</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>제목</label>
                        <input type="text" id="recordTitle" placeholder="기록의 핵심을 담은 제목">
                    </div>

                    <div class="form-group">
                        <label>내용</label>
                        <textarea id="recordContent" rows="6" placeholder="구체적이고 솔직한 기록을 작성하세요"></textarea>
                    </div>

                    <div class="form-group">
                        <label>태그 (쉼표로 구분)</label>
                        <input type="text" id="recordTags" placeholder="예: 발문, 참여도, 수학, 소수">
                    </div>

                    <div class="form-group">
                        <label>관련 기록 연결</label>
                        <select id="relatedRecord" multiple style="height: 80px;">
                            <!-- 기존 기록들이 여기 표시됩니다 -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label>중요도</label>
                        <select id="recordImportance">
                            <option value="low">낮음</option>
                            <option value="medium" selected>보통</option>
                            <option value="high">높음</option>
                            <option value="critical">매우 중요</option>
                        </select>
                    </div>

                    <button class="btn" onclick="saveRecord()">기록 저장</button>
                    <div id="saveStatus"></div>
                </div>

                <div class="record-history">
                    <h3>최근 기록</h3>
                    
                    <div class="search-filter">
                        <input type="text" id="searchInput" class="search-input" placeholder="기록 검색..." onkeyup="filterRecords()">
                        <select id="typeFilter" class="filter-select" onchange="filterRecords()">
                            <option value="">모든 유형</option>
                            <option value="reflection">수업 성찰</option>
                            <option value="observation">수업 관찰</option>
                            <option value="student_work">학생 결과물 분석</option>
                            <option value="experiment">수업 실험</option>
                            <option value="question">탐구 질문</option>
                            <option value="insight">깨달음/통찰</option>
                        </select>
                        <select id="sortOrder" class="filter-select" onchange="filterRecords()">
                            <option value="newest">최신순</option>
                            <option value="oldest">오래된순</option>
                            <option value="importance">중요도순</option>
                        </select>
                    </div>

                    <div id="recordList">
                        <!-- 기록들이 여기 표시됩니다 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 분석하기 섹션 -->
        <div class="content-section" id="analyze">
            <h2 class="section-title">데이터 분석 및 패턴 발견</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">총 기록 수</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="thisWeekRecords">0</div>
                    <div class="stat-label">이번 주 기록</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="topTag">-</div>
                    <div class="stat-label">가장 많은 태그</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgWeekly">0</div>
                    <div class="stat-label">주평균 기록</div>
                </div>
            </div>

            <div class="timeline" id="timeline">
                <!-- 타임라인이 여기 표시됩니다 -->
            </div>

            <div class="insight-card">
                <h4>📊 자동 패턴 분석 결과</h4>
                <div id="patternAnalysis">
                    데이터를 분석하여 패턴을 찾아드리겠습니다.
                </div>
            </div>

            <button class="btn" onclick="analyzePatterns()">패턴 분석 실행</button>
        </div>

        <!-- 통찰 도출 섹션 -->
        <div class="content-section" id="insight">
            <h2 class="section-title">통찰 도출 및 연결</h2>
            
            <div class="connection-map">
                <h3>기록 간 연결 관계</h3>
                <div id="connectionVisualization">
                    <!-- 연결 관계 시각화 -->
                </div>
                <button class="btn" onclick="generateConnections()">연결 관계 분석</button>
            </div>

            <div class="insight-card">
                <h4>🔍 AI 기반 통찰 제안</h4>
                <div id="aiInsights">
                    기록을 바탕으로 의미 있는 통찰을 제안해드리겠습니다.
                </div>
                <button class="btn" onclick="generateInsights()">통찰 생성</button>
            </div>
        </div>

        <!-- 성장 포트폴리오 섹션 -->
        <div class="content-section" id="portfolio">
            <h2 class="section-title">성장 여정 포트폴리오</h2>
            
            <div class="insight-card">
                <h4>📈 성장 지표</h4>
                <div id="growthMetrics">
                    <!-- 성장 지표 시각화 -->
                </div>
            </div>

            <div class="insight-card">
                <h4>📝 핵심 성찰 모음</h4>
                <div id="keyReflections">
                    <!-- 중요한 성찰들 -->
                </div>
            </div>

            <div class="insight-card">
                <h4>🎯 다음 탐구 과제</h4>
                <div id="nextQuestions">
                    <!-- 향후 탐구할 질문들 -->
                </div>
            </div>

            <button class="btn" onclick="generatePortfolio()">포트폴리오 생성</button>
            <button class="btn btn-secondary" onclick="exportPortfolio()">PDF 내보내기</button>
        </div>
    </div>

    <script>
        // 개선된 데이터 저장 구조
        let studyData = {
            records: [],
            connections: [],
            insights: [],
            settings: {
                autoSave: true,
                reminderFrequency: 'daily'
            },
            metadata: {
                created: new Date().toISOString(),
                lastModified: new Date().toISOString(),
                version: '2.0'
            }
        };

        // 기록 유형별 아이콘
        const recordTypeIcons = {
            reflection: '💭',
            observation: '👁️',
            student_work: '📊',
            experiment: '🧪',
            question: '❓',
            insight: '💡'
        };

        // 기록 유형별 한글명
        const recordTypeNames = {
            reflection: '수업 성찰',
            observation: '수업 관찰',
            student_work: '학생 결과물 분석',
            experiment: '수업 실험',
            question: '탐구 질문',
            insight: '깨달음/통찰'
        };

        // 초기화
        window.onload = function() {
            loadSampleData();
            updateRelatedRecordOptions();
            displayRecords();
            updateStats();
        };

        // 네비게이션
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 섹션별 초기 작업
            if (sectionId === 'analyze') {
                updateStats();
                generateTimeline();
            } else if (sectionId === 'insight') {
                updateConnectionVisualization();
            } else if (sectionId === 'portfolio') {
                updatePortfolio();
            }
        }

        // 새 기록 저장
        function saveRecord() {
            const record = {
                id: Date.now().toString(),
                type: document.getElementById('recordType').value,
                title: document.getElementById('recordTitle').value,
                content: document.getElementById('recordContent').value,
                tags: document.getElementById('recordTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                relatedRecords: Array.from(document.getElementById('relatedRecord').selectedOptions).map(option => option.value),
                importance: document.getElementById('recordImportance').value,
                timestamp: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };

            if (!record.title || !record.content) {
                showAlert('제목과 내용을 모두 입력해주세요.', 'info');
                return;
            }

            studyData.records.push(record);
            studyData.metadata.lastModified = new Date().toISOString();

            // 연결 관계 자동 생성
            if (record.relatedRecords.length > 0) {
                record.relatedRecords.forEach(relatedId => {
                    studyData.connections.push({
                        from: record.id,
                        to: relatedId,
                        type: 'manual',
                        strength: 1.0,
                        created: new Date().toISOString()
                    });
                });
            }

            // 폼 초기화
            document.getElementById('recordTitle').value = '';
            document.getElementById('recordContent').value = '';
            document.getElementById('recordTags').value = '';
            document.getElementById('relatedRecord').selectedIndex = -1;
            document.getElementById('recordImportance').value = 'medium';

            updateRelatedRecordOptions();
            displayRecords();
            updateStats();
            showAlert('기록이 저장되었습니다!', 'success');
        }

        // 기록 목록 표시
        function displayRecords() {
            const recordList = document.getElementById('recordList');
            let filteredRecords = [...studyData.records];

            // 정렬
            const sortOrder = document.getElementById('sortOrder').value;
            filteredRecords.sort((a, b) => {
                if (sortOrder === 'newest') {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                } else if (sortOrder === 'oldest') {
                    return new Date(a.timestamp) - new Date(b.timestamp);
                } else if (sortOrder === 'importance') {
                    const importanceOrder = { critical: 4, high: 3, medium: 2, low: 1 };
                    return importanceOrder[b.importance] - importanceOrder[a.importance];
                }
                return 0;
            });

            recordList.innerHTML = filteredRecords.map(record => `
                <div class="record-item" data-id="${record.id}">
                    <div class="record-header">
                        <span class="record-type">${recordTypeIcons[record.type]} ${recordTypeNames[record.type]}</span>
                        <span class="record-date">${new Date(record.timestamp).toLocaleDateString('ko-KR')}</span>
                    </div>
                    <h4>${record.title}</h4>
                    <div class="record-content">${record.content.substring(0, 150)}${record.content.length > 150 ? '...' : ''}</div>
                    <div class="record-tags">
                        ${record.tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-small" onclick="editRecord('${record.id}')">수정</button>
                        <button class="btn btn-small btn-secondary" onclick="deleteRecord('${record.id}')">삭제</button>
                        <span style="margin-left: 10px; font-size: 0.8rem; color: #7f8c8d;">중요도: ${getImportanceText(record.importance)}</span>
                    </div>
                </div>
            `).join('');
        }

        // 중요도 텍스트 변환
        function getImportanceText(importance) {
            const texts = { low: '낮음', medium: '보통', high: '높음', critical: '매우 중요' };
            return texts[importance] || '보통';
        }

        // 기록 필터링
        function filterRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;

            document.querySelectorAll('.record-item').forEach(item => {
                const title = item.querySelector('h4').textContent.toLowerCase();
                const content = item.querySelector('.record-content').textContent.toLowerCase();
                const type = item.dataset.id;
                const record = studyData.records.find(r => r.id === type);

                const matchesSearch = !searchTerm || title.includes(searchTerm) || content.includes(searchTerm) || 
                                    record.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                const matchesType = !typeFilter || record.type === typeFilter;

                item.style.display = matchesSearch && matchesType ? 'block' : 'none';
            });
        }

        // 관련 기록 옵션 업데이트
        function updateRelatedRecordOptions() {
            const select = document.getElementById('relatedRecord');
            select.innerHTML = studyData.records.map(record => 
                `<option value="${record.id}">${recordTypeIcons[record.type]} ${record.title}</option>`
            ).join('');
        }

        // 통계 업데이트
        function updateStats() {
            document.getElementById('totalRecords').textContent = studyData.records.length;
            
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const thisWeekRecords = studyData.records.filter(record => 
                new Date(record.timestamp) >= weekAgo
            );
            document.getElementById('thisWeekRecords').textContent = thisWeekRecords.length;

            // 가장 많이 사용된 태그
            const tagCounts = {};
            studyData.records.forEach(record => {
                record.tags.forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            const topTag = Object.entries(tagCounts).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('topTag').textContent = topTag ? `#${topTag[0]}` : '-';

            // 주평균 기록 수
            const firstRecord = studyData.records[0];
            if (firstRecord) {
                const daysSinceFirst = (now - new Date(firstRecord.timestamp)) / (1000 * 60 * 60 * 24);
                const weeksSinceFirst = Math.max(1, Math.ceil(daysSinceFirst / 7));
                const avgWeekly = Math.round(studyData.records.length / weeksSinceFirst * 10) / 10;
                document.getElementById('avgWeekly').textContent = avgWeekly;
            }
        }

        // 타임라인 생성
        function generateTimeline() {
            const timeline = document.getElementById('timeline');
            const sortedRecords = [...studyData.records]
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                .slice(-10); // 최근 10개만

            timeline.innerHTML = sortedRecords.map((record, index) => `
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="insight-card">
                        <h4>${recordTypeIcons[record.type]} ${record.title}</h4>
                        <p>${record.content.substring(0, 100)}...</p>
                        <small>${new Date(record.timestamp).toLocaleDateString('ko-KR')}</small>
                    </div>
                </div>
            `).join('');
        }

        // 패턴 분석
        function analyzePatterns() {
            const analysis = document.getElementById('patternAnalysis');
            
            // 간단한 패턴 분석 예시
            const patterns = [];
            
            // 시간대별 분석
            const hourCounts = {};
            studyData.records.forEach(record => {
                const hour = new Date(record.timestamp).getHours();
                hourCounts[hour] = (hourCounts[hour] || 0) + 1;
            });
            const peakHour = Object.entries(hourCounts).sort((a, b) => b[1] - a[1])[0];
            if (peakHour) {
                patterns.push(`주로 ${peakHour[0]}시경에 기록을 작성하시는군요!`);
            }

            // 태그 동시 출현 분석
            const tagPairs = {};
            studyData.records.forEach(record => {
                for (let i = 0; i < record.tags.length; i++) {
                    for (let j = i + 1; j < record.tags.length; j++) {
                        const pair = [record.tags[i], record.tags[j]].sort().join('-');
                        tagPairs[pair] = (tagPairs[pair] || 0) + 1;
                    }
                }
            });
            const topPair = Object.entries(tagPairs).sort((a, b) => b[1] - a[1])[0];
            if (topPair && topPair[1] > 1) {
                patterns.push(`'${topPair[0].replace('-', '과 ')}'가 자주 함께 등장합니다.`);
            }

            // 성장 패턴 분석
            const reflectionRecords = studyData.records.filter(r => r.type === 'reflection');
            if (reflectionRecords.length >= 3) {
                patterns.push(`성찰 기록이 ${reflectionRecords.length}개 누적되어 지속적인 자기 개선이 이루어지고 있습니다.`);
            }

            analysis.innerHTML = patterns.length > 0 ? 
                `<ul>${patterns.map(p => `<li>${p}</li>`).join('')}</ul>` : 
                '더 많은 데이터가 쌓이면 의미 있는 패턴을 찾을 수 있습니다.';
        }

        // 연결 관계 시각화
        function updateConnectionVisualization() {
            const viz = document.getElementById('connectionVisualization');
            const connections = studyData.connections.length;
            const avgConnections = connections > 0 ? Math.round(connections / studyData.records.length * 10) / 10 : 0;
            
            viz.innerHTML = `
                <p>총 ${connections}개의 기록 간 연결이 발견되었습니다.</p>
                <p>평균적으로 기록당 ${avgConnections}개의 연결이 있습니다.</p>
                <p>이는 ${avgConnections > 1 ? '높은' : '낮은'} 수준의 기록 간 연관성을 나타냅니다.</p>
            `;
        }

        // 연결 관계 생성
        function generateConnections() {
            // 태그 기반 자동 연결 생성
            let newConnections = 0;
            
            for (let i = 0; i < studyData.records.length; i++) {
                for (let j = i + 1; j < studyData.records.length; j++) {
                    const record1 = studyData.records[i];
                    const record2 = studyData.records[j];
                    
                    // 공통 태그가 2개 이상이면 연결
                    const commonTags = record1.tags.filter(tag => record2.tags.includes(tag));
                    if (commonTags.length >= 2) {
                        const connectionExists = studyData.connections.some(conn => 
                            (conn.from === record1.id && conn.to === record2.id) ||
                            (conn.from === record2.id && conn.to === record1.id)
                        );
                        
                        if (!connectionExists) {
                            studyData.connections.push({
                                from: record1.id,
                                to: record2.id,
                                type: 'auto',
                                strength: commonTags.length / Math.max(record1.tags.length, record2.tags.length),
                                commonTags: commonTags,
                                created: new Date().toISOString()
                            });
                            newConnections++;
                        }
                    }
                }
            }
            
            updateConnectionVisualization();
            showAlert(`${newConnections}개의 새로운 연결을 발견했습니다!`, 'success');
        }

        // 통찰 생성
        function generateInsights() {
            const insights = document.getElementById('aiInsights');
            const generatedInsights = [];
            
            // 기록 유형별 분포 분석
            const typeCounts = {};
            studyData.records.forEach(record => {
                typeCounts[record.type] = (typeCounts[record.type] || 0) + 1;
            });
            
            const dominantType = Object.entries(typeCounts).sort((a, b) => b[1] - a[1])[0];
            if (dominantType) {
                generatedInsights.push(`가장 많이 기록하는 유형은 '${recordTypeNames[dominantType[0]]}'입니다. 이는 ${dominantType[0] === 'reflection' ? '내성적 성찰' : dominantType[0] === 'observation' ? '관찰 중심적 탐구' : '실험적 접근'}을 선호함을 보여줍니다.`);
            }

            // 기록 빈도 패턴
            const recordDates = studyData.records.map(r => new Date(r.timestamp).toDateString());
            const uniqueDates = [...new Set(recordDates)];
            const avgRecordsPerDay = Math.round(studyData.records.length / uniqueDates.length * 10) / 10;
            
            if (avgRecordsPerDay > 1) {
                generatedInsights.push(`하루 평균 ${avgRecordsPerDay}개의 기록을 작성하여 매우 활발한 성찰 활동을 하고 있습니다.`);
            } else {
                generatedInsights.push(`꾸준하지만 신중한 기록 작성 패턴을 보이고 있습니다. 질적 깊이를 중시하는 것으로 보입니다.`);
            }

            // 성장 지표
            if (studyData.records.length >= 5) {
                generatedInsights.push(`${studyData.records.length}개의 기록 축적으로 체계적인 셀프스터디가 자리잡고 있습니다. 지속적인 전문성 개발의 좋은 기반이 되고 있습니다.`);
            }

            insights.innerHTML = generatedInsights.length > 0 ? 
                `<ul>${generatedInsights.map(insight => `<li>💡 ${insight}</li>`).join('')}</ul>` :
                '더 많은 기록이 축적되면 개인화된 통찰을 제공해드릴 수 있습니다.';
        }

        // 포트폴리오 업데이트
        function updatePortfolio() {
            // 성장 지표
            const growthMetrics = document.getElementById('growthMetrics');
            const totalDays = Math.ceil((Date.now() - new Date(studyData.records[0]?.timestamp || Date.now())) / (1000 * 60 * 60 * 24));
            
            growthMetrics.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${totalDays}</div>
                        <div class="stat-label">연구 진행 일수</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${studyData.records.length}</div>
                        <div class="stat-label">누적 기록 수</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${studyData.connections.length}</div>
                        <div class="stat-label">발견된 연결점</div>
                    </div>
                </div>
            `;

            // 핵심 성찰 모음
            const keyReflections = document.getElementById('keyReflections');
            const importantRecords = studyData.records
                .filter(r => r.importance === 'high' || r.importance === 'critical')
                .slice(-5);
            
            keyReflections.innerHTML = importantRecords.map(record => `
                <div class="insight-card" style="margin: 10px 0;">
                    <h5>${recordTypeIcons[record.type]} ${record.title}</h5>
                    <p>${record.content.substring(0, 200)}...</p>
                    <small>${new Date(record.timestamp).toLocaleDateString('ko-KR')}</small>
                </div>
            `).join('') || '<p>중요도가 높은 기록이 없습니다.</p>';

            // 다음 탐구 과제
            const nextQuestions = document.getElementById('nextQuestions');
            const questionRecords = studyData.records.filter(r => r.type === 'question').slice(-3);
            
            nextQuestions.innerHTML = questionRecords.map(record => `
                <div style="margin: 10px 0; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px;">
                    <h5>❓ ${record.title}</h5>
                    <p>${record.content}</p>
                </div>
            `).join('') || '<p>탐구 질문을 기록해보세요!</p>';
        }

        // 데이터 관리 기능들
        function exportData() {
            const dataStr = JSON.stringify(studyData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `selfstudy_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAlert('데이터를 다운로드했습니다!', 'success');
        }

        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.records && Array.isArray(importedData.records)) {
                        studyData = importedData;
                        updateRelatedRecordOptions();
                        displayRecords();
                        updateStats();
                        showAlert('데이터를 성공적으로 불러왔습니다!', 'success');
                    } else {
                        throw new Error('잘못된 데이터 형식');
                    }
                } catch (error) {
                    showAlert('데이터 파일이 올바르지 않습니다.', 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                studyData = {
                    records: [],
                    connections: [],
                    insights: [],
                    settings: { autoSave: true, reminderFrequency: 'daily' },
                    metadata: {
                        created: new Date().toISOString(),
                        lastModified: new Date().toISOString(),
                        version: '2.0'
                    }
                };
                updateRelatedRecordOptions();
                displayRecords();
                updateStats();
                showAlert('모든 데이터가 삭제되었습니다.', 'info');
            }
        }

        // 유틸리티 함수들
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'info' : type}`;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        function editRecord(recordId) {
            const record = studyData.records.find(r => r.id === recordId);
            if (record) {
                document.getElementById('recordType').value = record.type;
                document.getElementById('recordTitle').value = record.title;
                document.getElementById('recordContent').value = record.content;
                document.getElementById('recordTags').value = record.tags.join(', ');
                document.getElementById('recordImportance').value = record.importance;
                
                // 기존 기록 삭제
                deleteRecord(recordId, false);
            }
        }

        function deleteRecord(recordId, confirm = true) {
            if (confirm && !window.confirm('이 기록을 삭제하시겠습니까?')) {
                return;
            }
            
            studyData.records = studyData.records.filter(r => r.id !== recordId);
            studyData.connections = studyData.connections.filter(c => c.from !== recordId && c.to !== recordId);
            
            updateRelatedRecordOptions();
            displayRecords();
            updateStats();
            
            if (confirm) {
                showAlert('기록이 삭제되었습니다.', 'success');
            }
        }

        function generatePortfolio() {
            showAlert('포트폴리오 생성 기능은 개발 중입니다.', 'info');
        }

        function exportPortfolio() {
            showAlert('PDF 내보내기 기능은 개발 중입니다.', 'info');
        }

        // 샘플 데이터 로드 (테스트용)
        function loadSampleData() {
            if (studyData.records.length === 0) {
                studyData.records = [
                    {
                        id: '1',
                        type: 'reflection',
                        title: '오늘 수업에서 학생들의 질문이 적었던 이유',
                        content: '평소보다 학생들이 질문을 많이 하지 않았다. 새로운 개념(분수의 나눗셈)을 설명할 때 아이들이 조용했는데, 이게 이해를 못한 건지 아니면 너무 어려워서 질문할 엄두를 못 낸 건지 궁금하다. 다음 시간엔 더 작은 단계로 나누어서 설명해볼 필요가 있을 것 같다.',
                        tags: ['질문', '분수', '수학', '참여도'],
                        relatedRecords: [],
                        importance: 'medium',
                        timestamp: new Date(Date.now() - 86400000).toISOString(),
                        lastModified: new Date(Date.now() - 86400000).toISOString()
                    },
                    {
                        id: '2',
                        type: 'observation',
                        title: '민수의 발표 참여도 변화',
                        content: '지난 달까지 발표를 거의 하지 않던 민수가 오늘 적극적으로 손을 들고 자신의 의견을 말했다. 소그룹 활동을 먼저 한 후 전체 발표로 이어진 것이 효과가 있었던 것 같다. 다른 내성적인 아이들도 비슷한 패턴을 보이는지 관찰해보자.',
                        tags: ['발표', '참여도', '소그룹', '민수'],
                        relatedRecords: [],
                        importance: 'high',
                        timestamp: new Date(Date.now() - 172800000).toISOString(),
                        lastModified: new Date(Date.now() - 172800000).toISOString()
                    },
                    {
                        id: '3',
                        type: 'student_work',
                        title: '서술형 평가 결과 분석',
                        content: '이번 서술형 평가에서 학생들이 계산은 잘했지만 문제 해결 과정을 설명하는 부분에서 많이 어려워했다. 특히 "왜 그렇게 생각했는지" 설명하는 문항에서 점수가 낮았다. 사고 과정을 말로 표현하는 연습이 더 필요할 것 같다.',
                        tags: ['서술형', '평가', '사고과정', '설명'],
                        relatedRecords: [],
                        importance: 'high',
                        timestamp: new Date(Date.now() - 259200000).toISOString(),
                        lastModified: new Date(Date.now() - 259200000).toISOString()
                    },
                    {
                        id: '4',
                        type: 'experiment',
                        title: '게임 기반 학습 시도',
                        content: '곱셈구구를 외우는 대신 카드게임으로 접근해봤다. 아이들이 훨씬 즐거워했고 자연스럽게 암기가 되는 것 같았다. 하지만 시간이 더 오래 걸렸고, 일부 아이들은 게임에만 집중해서 학습 목표를 놓치는 경우가 있었다. 적절한 균형점을 찾아야겠다.',
                        tags: ['게임', '곱셈구구', '암기', '재미'],
                        relatedRecords: [],
                        importance: 'medium',
                        timestamp: new Date(Date.now() - 345600000).toISOString(),
                        lastModified: new Date(Date.now() - 345600000).toISOString()
                    },
                    {
                        id: '5',
                        type: 'question',
                        title: '내향적 성격의 학생들을 어떻게 더 참여시킬 수 있을까?',
                        content: '우리 반에 조용한 성격의 아이들이 몇 명 있다. 이 아이들도 분명 좋은 아이디어를 가지고 있을 텐데 큰 소리로 발표하기를 어려워한다. 어떻게 하면 이런 아이들의 생각도 수업에 자연스럽게 포함시킬 수 있을까? 글쓰기나 그림, 또는 작은 그룹 활동이 도움이 될까?',
                        tags: ['내향성', '참여', '발표', '소그룹'],
                        relatedRecords: ['2'],
                        importance: 'high',
                        timestamp: new Date(Date.now() - 432000000).toISOString(),
                        lastModified: new Date(Date.now() - 432000000).toISOString()
                    },
                    {
                        id: '6',
                        type: 'insight',
                        title: '아이들의 실수에서 배우는 것',
                        content: '오늘 수업 중 한 학생이 틀린 답을 말했는데, 그 실수를 통해 다른 아이들이 더 깊이 생각하게 되었다. 실수를 단순히 "틀렸다"고 넘기지 않고 "왜 그렇게 생각했을까?"라고 물어보니 전체적인 이해도가 높아진 것 같다. 실수도 학습의 중요한 자원이구나.',
                        tags: ['실수', '학습', '질문', '이해'],
                        relatedRecords: [],
                        importance: 'critical',
                        timestamp: new Date(Date.now() - 518400000).toISOString(),
                        lastModified: new Date(Date.now() - 518400000).toISOString()
                    }
                ];

                // 샘플 연결 관계 생성
                studyData.connections = [
                    {
                        from: '2',
                        to: '5',
                        type: 'manual',
                        strength: 1.0,
                        created: new Date(Date.now() - 400000000).toISOString()
                    }
                ];
            }
        }

        // 자동 저장 (실제 환경에서는 로컬스토리지나 서버에 저장)
        function autoSave() {
            if (studyData.settings.autoSave) {
                // 실제 구현시에는 localStorage.setItem('studyData', JSON.stringify(studyData)); 
                // 또는 서버로 데이터 전송
                document.getElementById('dataStatus').textContent = `마지막 저장: ${new Date().toLocaleTimeString()}`;
            }
        }

        // 주기적 자동 저장 (30초마다)
        setInterval(autoSave, 30000);
    </script>
</body>
</html>
